# 区块链的共识机制
区块链本质上也是一个分布式系统。它是由分布在不同区域的区块链节点组成，节点之间往往是通过企业内网、广域网或者互联网连接，节点之间通讯的网络延时也依赖于网络类型和距离相关，这些分布在不同区域的节点，实际上是互为复本，那么就必须保证不同复本中存储的区块链数据最终是一致的，这种确保不同节点达成一致的过程就称作为共识机制。
# 问题和挑战
如果节点在一个理想的环境下达成一致也相对容易一些，只需要通过消息之间通讯可以就可以达成一致，例如常见的分布式系统一致性算法有Paxos、Raft等等协议，这些共识算法可以允许超过一半的节点失败，但是把这些算法放在区块链公链的环境下去使用，就存在很多问题。首先公链中的节点是可以自由加入的，除了这些节点不可靠随时会停止之外，这些自由加入的节点还有可能是恶意节点，即它有可能发送一些伪造的消息，这样就会干扰共识算法，而上述共识算法是无法应对这种被称作为“拜占庭”故障的。其次。公链中的节点可以任意加入，数量巨大，互联网情况复杂，性能差，每次达成共识都要发送提案给其它所有的节点，等待超过一半以上的节点反馈，这样的算法效率也是低下的，性能很差。这些问题就要求在区块链这种分布式系统中需要寻求其它的共识机制来解决达成一致的问题。
# 比特币网络的PoW共识机制
比特币是区块链的鼻祖，它设计了一个非常巧妙的共识算法——PoW，可解决公链中其它算法存在的一些弊端。它不是利用节点执行的通讯来达成共识的，而是利用工作量证明机制来实现的，它的计算过程是将区块头的80个字节作为工作量证明的输入，然后不停的更换区块头中的随机数，及nonce的素质，并对每次变更后的区块头做双重SHA256运算（即SHA256(SHA256(Block_Header))),将结果与当前网络的目标值做对比，如果小于目标值，则解题成功，工作量证明完成，这就是比特币中的“挖矿”过程，这个运算过程需要花费很多算力，为了保证难度，难度会逐渐增加，保障算法的安全性，确保大约10分钟左右才能算出一个区块，而正因为如此，也让基于PoW共识机制的比特币网络的交易速度非常慢，10分钟才能产生一个区块（一个区块1000个交易，每10分钟产生一个交易，也就是100交易每分钟，太低了。），同时产生了大量的计算资源的浪费，这些弊端导致比特币不适合用于日常的小额支付当要求吞吐量大（例如要求每秒10万交易量）的场景，这也大大限制了比特币的使用场景，这是PoW共识机制的最大问题。但是PoW共识机制可允许小于50%的节点故障，包括对于拜占庭故障的容错，因此它可以允许任意数量的任意节点加入到区块链网络中，这就充分保障了公链的去中心化特性。
# fabric联盟链的PBFT共识机制
BFT算法可以解决拜占庭问题，但是算法复杂度过高，实用价值不高。后来出现了实用拜占庭容错算法PBFT，该算法的复杂度降低为多项式的级别，具有较高的使用价值，Hyerledger farbic 0.6版本这种联盟链区块链网络就支持了PBTF算法，该算法具有可以容小于1/3节点拜占庭错误的优势，并且吞吐量可达到每秒钟1W-10W的交易量，相对于PoW已经大大提高了，PBFT算法采用密码学相关技术（RSA签名算法、摘要等）确保消息传递过程无法被篡改和破坏，该算法基本过程如下：
1. 首先通过轮换或随机算法选择某个节点为主节点，此后只要主节点不切换，则成为一个视图;
2. 在某给视图中，客户端将请求<Request,operation,timestamp,client>发送给主节点，主节点负责广播请求到所有其它复本节点；
3. 所有节点处理完成请求，将处理结果《Reply,view,timestamp,client,id_node,response>返回给客户端。客户端检查是否收到了至少n/3+1（n是总节点个数）各来自不同节点的相同结果，作为最终结果。
从这个算法过程也可以看出来，PBFT算法也需要将消息广播给所有的节点，而且客户端需要接收所有节点的响应，要等到n/3+1节点的响应结果，因此如果节点数N太大的话，算法效率也会非常低，它要求参与记账的节点彼此信任。
# 初链使用的混合共识机制
初链希望打造承载未来商业去中心化应用的公链，希望初链能够具备以下特性。
* 支持无限节点加入。
* 安全性高。
* 高性能。

而要同时满足这些特点，看似是矛盾的，因为去中心化和共识效率本身就存在矛盾，PoW共识机制可以满足支持无限节点和安全性特性，但是不满足高性能特性；而PBFT共识机制可以满足高性能，但是不能满足支持无限节点和安全性，为了解决这个矛盾，R. Pass and E. Shi.提出的Hybrid consensus混合共识可以让鱼和熊掌兼得，初链是引用了该混合共识理论，将PoW和PBFT两种共识机制结合起来，使得初链这种公链更具有实用价值，能够广泛得应用各种领域。
初链首先利用PoW共识机制，让任意加入的去中心化节点达成共识，选出一些超级节点，这些超级节点是作为PBFT共识的参与者，为了达到高效共识，选出的超级节点数量不宜过多，初链还会在监督和管理这些超级节点，当发现这些超级节点有失效或者出现拜占庭错误的情况下，则会将它剔除掉，重新选取一些节点作为超级节点。
然后这些超级节点作为PBFT共识机制的参与者，彼此互相认识，交换对方的公钥，然后通过PBFT协议达成共识，实现高效共识。

# 我的想法和启示
既然作为一个通用的区块链公用平台，可应用于各种领域，也设计了智能合约，那么初链上就会允许各种区块链Dapp，那么不同的Dapp实际是隔离的，也就是实际上可以形成不同的区块链，可以参考fabric项目中的“通道”概念，在初链中划分出不同的“通道”，每个“通道”就是一个区块链，这样在利用PoW选择超级节点的时候，就可以选择多组超级节点，从而提升了共识的吞吐量，让更多的节点担任PBFT共识参与者。
最后我的感想：我们用计算机互联网技术来建模解决现实世界的问题，而现实世界往往是复杂和多元的，那么仅仅使用一种模式，它能够带来绝大好处，然后事务总是有两面性的，单一模式带来的好处越大，那么它的另外一面缺点也就越突出，因此我们需要混合两种甚至是多种模式，来取长补短，不同的场景使用不同的模式，从而更加全面的应对现实问题，而混合共识正是这样一种解决方案。就好比中心化的应用（传统数据库应用）和去中心化的应用（区块链应用）两者也是各有优劣，去中心化的效率低下，成本极高，而这也正是中心化应用擅长的地方，两者应该混合结合，共同来混合来解决现实的问题。因此解决现实世界的问题应该是各种大“混合”，扬长避短。
